# Copyright 2020-2022 F4PGA Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

name: Pipeline

on:
  push:
  pull_request:

jobs:


  License-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - uses: SymbiFlow/actions/checks@main
      with:
        exclude_license: |
          ./yosys-plugins/design_introspection/tests/selection_to_tcl_list/selection_to_tcl_list.v
          ./third_party/minilitex_ddr_arty/minilitex_ddr_arty.v
          ./third_party/VexRiscv_Lite/VexRiscv_Lite.v
        third_party: |
          ./third_party/googletest/


  Run-tests:
    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - uses: actions/setup-python@v2

    - name: Install
      run: |
        sudo apt-get update
        sudo apt-get install \
          bison \
          build-essential \
          clang-format-8 \
          cmake \
          flex \
          g++-9 \
          gawk \
          git \
          graphviz \
          libffi-dev \
          libboost-system-dev \
          libboost-python-dev \
          libboost-filesystem-dev \
          libreadline-dev \
          pkg-config \
          tcl-dev \
          xdot \
          zlib1g-dev

    - name: Format
      run: |
        set -e
        source .github/scripts/common.sh
        make -C yosys-plugins format -j`nproc`
        test $(git status --porcelain | wc -l) -eq 0 || { git diff; false; }

    - name: ccache
      uses: hendrikmuhs/ccache-action@v1

    - name: Install Yosys
      run: |
        export PATH="/usr/lib/ccache:/usr/local/opt/ccache/libexec:$PATH"
        source .github/scripts/setup.sh

    - name: Build and test plugins
      run: |
        export PATH="/usr/lib/ccache:/usr/local/opt/ccache/libexec:$PATH"
        source yosys-plugins/env/conda/bin/activate yosys-plugins
        source .github/scripts/build-and-test.sh
